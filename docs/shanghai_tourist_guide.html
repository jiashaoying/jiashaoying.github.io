<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>上海全域旅行指南 - 纯净版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Swiper CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              shanghai: {
                red: "#E63946",
                dark: "#1D3557",
                bg: "#F3F4F6",
              },
              metro: {
                l1: "#E4002B",
                l2: "#6BCF63",
                l3: "#FFD900",
                l4: "#3D62AF",
                l5: "#A05DA5",
                l6: "#CF0072",
                l7: "#F77D1C",
                l8: "#008BB9",
                l9: "#93C90E",
                l10: "#00A0E9",
                l11: "#8C4799",
                l12: "#007E62",
                l13: "#F7B500",
                l14: "#9D7D2C",
                l16: "#66D6C0",
              },
            },
            fontFamily: {
              sans: ['"Noto Sans SC"', "sans-serif"],
            },
            animation: {
              "spin-slow": "spin 8s linear infinite",
              "pulse-fast": "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>

    <style>
      /* 隐藏滚动条 */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* 详情页进入动画 */
      .modal-enter {
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .modal-exit {
        animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      @keyframes slideUp {
        0% {
          transform: translateY(100%);
          opacity: 0;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes slideDown {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        100% {
          transform: translateY(100%);
          opacity: 0;
        }
      }

      /* 瀑布流防断裂 */
      .break-inside-avoid {
        break-inside: avoid;
      }

      /* 搜索框聚焦动效 */
      .search-input:focus {
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
      }

      /* 音乐播放器动画 */
      .music-disc {
        transition: all 0.5s ease;
      }
      .music-playing .music-disc {
        animation: spin 4s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* 页面切换动画 */
      .page-enter {
        animation: fadeIn 0.3s ease-out forwards;
      }
      .page-exit {
        animation: fadeOut 0.3s ease-in forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      /* Tab 激活状态 */
      .tab-item.active {
        color: #e63946;
      }
      .tab-item.active i {
        transform: scale(1.1);
      }
    </style>
  </head>
  <body class="bg-shanghai-bg text-slate-800 font-sans pb-24">
    <!-- 背景音乐 (使用免版权音乐源) -->
    <!-- 注意：为了更好的用户体验，建议不要设置 autoplay，或者设置 muted autoplay -->
    <audio id="bg-music" loop>
      <source
        src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"
        type="audio/mpeg"
      />
      您的浏览器不支持 audio 元素。
    </audio>

    <!-- 音乐控制按钮 (悬浮在页面中间右侧) -->
    <div class="fixed top-1/2 -translate-y-1/2 right-3 z-50">
      <button
        id="music-btn"
        onclick="toggleMusic()"
        class="w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-shanghai-dark hover:text-shanghai-red transition-all duration-300 border border-gray-100 group"
      >
        <!-- 播放状态图标 -->
        <div
          id="music-icon-playing"
          class="hidden absolute inset-0 flex items-center justify-center"
        >
          <div
            class="w-6 h-6 rounded-full bg-shanghai-red text-white flex items-center justify-center music-disc"
          >
            <i class="fas fa-music text-[10px]"></i>
          </div>
        </div>
        <!-- 暂停状态图标 -->
        <div
          id="music-icon-paused"
          class="flex items-center justify-center w-full h-full"
        >
          <i
            class="fas fa-play text-base ml-0.5 group-hover:scale-110 transition-transform"
          ></i>
          <!-- 提示波纹 -->
          <span
            class="absolute inset-0 rounded-full border border-shanghai-red opacity-0 group-hover:animate-ping"
          ></span>
        </div>
      </button>
    </div>

    <!-- 顶部 Header & 搜索 -->
    <header
      class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-200 px-4 py-4 shadow-sm transition-all duration-300"
      id="main-header"
    >
      <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h1 class="text-xl font-bold text-shanghai-dark tracking-tight">
              上海漫游 <span class="text-shanghai-red">·</span> 指南
            </h1>
          </div>
          <div class="text-xs text-gray-400 font-medium">
            <i class="fas fa-map-marker-alt mr-1"></i>当前位置：上海
          </div>
        </div>

        <!-- 搜索框 -->
        <div class="relative group">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i
              class="fas fa-search text-gray-400 group-focus-within:text-shanghai-red transition-colors"
            ></i>
          </div>
          <input
            type="text"
            id="search-input"
            class="search-input block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-shanghai-red transition-all duration-300 sm:text-sm"
            placeholder="搜索景点、商圈或地铁线路..."
          />
          <div
            class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
            onclick="clearSearch()"
          >
            <i
              id="clear-btn"
              class="fas fa-times-circle text-gray-300 hover:text-gray-500 hidden"
            ></i>
          </div>
        </div>

        <!-- 区域筛选器 -->
        <div
          class="flex space-x-3 overflow-x-auto hide-scrollbar mt-4 pb-1"
          id="region-filter"
        >
          <!-- JS 生成 -->
        </div>
      </div>
    </header>

    <!-- 主内容区域 -->
    <main id="main-content" class="min-h-screen">
      <!-- 首页 -->
      <section id="page-home" class="page-section px-4 py-6 max-w-7xl mx-auto">
        <div
          id="masonry-grid"
          class="columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4"
        >
          <!-- 卡片注入 -->
        </div>

        <!-- 空状态 -->
        <div
          id="empty-state"
          class="hidden flex flex-col items-center justify-center py-20 text-gray-400"
        >
          <div
            class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4"
          >
            <i class="fas fa-search text-2xl text-gray-400"></i>
          </div>
          <p class="text-sm font-medium">未找到相关地点</p>
          <p class="text-xs mt-1">尝试切换区域或搜索关键词</p>
        </div>
      </section>

      <!-- 收藏页 -->
      <section
        id="page-favorites"
        class="page-section hidden px-4 py-6 max-w-7xl mx-auto"
      >
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-slate-900">我的收藏</h2>
          <span id="favorites-count" class="text-sm text-gray-500"
            >0 个地点</span
          >
        </div>
        <div
          id="favorites-grid"
          class="columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4"
        >
          <!-- 收藏卡片注入 -->
        </div>
        <div
          id="favorites-empty"
          class="hidden flex flex-col items-center justify-center py-20 text-gray-400"
        >
          <div
            class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4"
          >
            <i class="far fa-heart text-3xl text-gray-400"></i>
          </div>
          <p class="text-sm font-medium">暂无收藏</p>
          <p class="text-xs mt-1">点击卡片上的心形图标添加收藏</p>
        </div>
      </section>

      <!-- 行程页 -->
      <section
        id="page-itinerary"
        class="page-section hidden px-4 py-6 max-w-7xl mx-auto"
      >
        <h2 class="text-2xl font-bold text-slate-900 mb-6">我的行程</h2>
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
          <div
            class="flex flex-col items-center justify-center py-12 text-gray-400"
          >
            <i class="fas fa-calendar-alt text-4xl mb-4"></i>
            <p class="text-sm font-medium">行程规划功能开发中</p>
            <p class="text-xs mt-1">敬请期待</p>
          </div>
        </div>
      </section>
    </main>

    <!-- 底部 Tab 栏 -->
    <nav
      class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40 px-4 pb-safe"
    >
      <div class="max-w-7xl mx-auto flex justify-around items-center py-2">
        <button
          onclick="switchPage('home')"
          class="tab-item active flex flex-col items-center py-2 px-4 text-gray-400 transition-all duration-300"
          data-page="home"
        >
          <i
            class="fas fa-home text-xl mb-1 transition-transform duration-300"
          ></i>
          <span class="text-xs font-medium">首页</span>
        </button>
        <button
          onclick="switchPage('favorites')"
          class="tab-item flex flex-col items-center py-2 px-4 text-gray-400 transition-all duration-300"
          data-page="favorites"
        >
          <i
            class="fas fa-heart text-xl mb-1 transition-transform duration-300"
          ></i>
          <span class="text-xs font-medium">收藏</span>
        </button>
        <button
          onclick="switchPage('itinerary')"
          class="tab-item flex flex-col items-center py-2 px-4 text-gray-400 transition-all duration-300"
          data-page="itinerary"
        >
          <i
            class="fas fa-calendar-alt text-xl mb-1 transition-transform duration-300"
          ></i>
          <span class="text-xs font-medium">行程</span>
        </button>
      </div>
    </nav>

    <!-- 详情弹窗 -->
    <div
      id="detail-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria
      aria-modal="true"
    >
      <!-- 背景遮罩 -->
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0"
        id="modal-backdrop"
        onclick="closeModal()"
      ></div>

      <!-- 弹窗内容 -->
      <div
        class="absolute inset-x-0 bottom-0 top-0 md:top-auto md:bottom-auto md:inset-0 md:flex md:items-center md:justify-center pointer-events-none"
      >
        <div
          id="modal-content"
          class="bg-white w-full h-[90vh] md:h-auto md:max-w-2xl md:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden pointer-events-auto flex flex-col"
        >
          <!-- 弹窗头部 (无图片，纯色背景) -->
          <div
            class="relative min-h-40 md:min-h-48 flex-shrink-0 bg-shanghai-dark px-6 md:px-10 py-6"
          >
            <!-- 装饰背景圆圈 -->
            <div
              class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 pointer-events-none"
            ></div>
            <div
              class="absolute bottom-0 left-0 w-32 h-32 bg-white/5 rounded-full -ml-10 -mb-10 pointer-events-none"
            ></div>

            <!-- 关闭按钮 -->
            <button
              onclick="closeModal()"
              class="absolute top-4 right-4 w-10 h-10 md:w-12 md:h-12 rounded-full bg-white/10 backdrop-blur hover:bg-white/20 transition-colors z-20 flex items-center justify-center overflow-hidden"
            >
              <svg
                class="w-10 h-10 md:w-12 md:h-12 text-white"
                viewBox="0 0 48 48"
                fill="none"
              >
                <rect
                  width="48"
                  height="48"
                  rx="24"
                  fill="rgba(255,255,255,0.1)"
                />
                <path
                  d="M15 15L33 33M33 15L15 33"
                  stroke="white"
                  stroke-width="3"
                  stroke-linecap="round"
                />
              </svg>
            </button>

            <div class="relative z-10 pr-16 md:pr-20">
              <span
                id="modal-region"
                class="inline-block px-2 py-1 bg-shanghai-red/90 rounded text-[10px] font-bold tracking-wider uppercase mb-2 backdrop-blur-sm"
                >Region</span
              >
              <h2
                id="modal-title"
                class="text-2xl md:text-4xl font-bold text-white leading-tight break-words"
              >
                Title
              </h2>
              <div
                class="flex items-center mt-2 text-xs md:text-sm text-gray-300"
              >
                <i class="fas fa-star text-yellow-400 mr-1"></i>
                <span>4.8</span>
                <span class="mx-2">•</span>
                <span>热门推荐</span>
              </div>
            </div>
          </div>

          <!-- 弹窗滚动内容区 -->
          <div class="flex-1 overflow-y-auto p-6 md:p-8">
            <!-- 照片展示 -->
            <div id="modal-photos" class="mb-8">
              <h3
                class="text-lg font-bold text-slate-900 mb-3 flex items-center"
              >
                <i class="fas fa-images text-shanghai-red mr-2"></i> 照片
              </h3>
              <div class="relative">
                <!-- Swiper 轮播图 -->
                <div class="swiper photos-swiper">
                  <div class="swiper-wrapper" id="photos-container">
                    <!-- Photos injected here -->
                  </div>
                  <!-- 导航按钮 -->
                  <div class="swiper-button-prev"></div>
                  <div class="swiper-button-next"></div>
                  <!-- 分页器 -->
                  <div class="swiper-pagination"></div>
                </div>
              </div>
            </div>

            <!-- 简介 -->
            <div class="mb-8">
              <h3
                class="text-lg font-bold text-slate-900 mb-3 flex items-center"
              >
                <i class="fas fa-info-circle text-shanghai-red mr-2"></i> 简介
              </h3>
              <p
                id="modal-desc"
                class="text-gray-600 leading-relaxed text-justify"
              >
                Description goes here...
              </p>
            </div>

            <!-- 交通信息 -->
            <div class="mb-8">
              <h3
                class="text-lg font-bold text-slate-900 mb-3 flex items-center"
              >
                <i class="fas fa-subway text-shanghai-red mr-2"></i> 交通指南
              </h3>
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <div class="flex items-start">
                  <div class="flex-shrink-0 mt-1">
                    <i class="fas fa-map-pin text-gray-400"></i>
                  </div>
                  <div class="ml-3 flex-1">
                    <p
                      id="modal-metro-text"
                      class="text-sm font-medium text-gray-800 mb-2"
                    >
                      Station Name
                    </p>
                    <div id="modal-metro-tags" class="flex flex-wrap gap-2">
                      <!-- Tags injected here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 操作按钮 -->
            <div class="grid grid-cols-2 gap-4">
              <button
                onclick="showNotImplemented('分享')"
                class="w-full py-3 rounded-xl border border-gray-200 text-gray-700 font-bold hover:bg-gray-50 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-share-alt mr-2"></i> 分享
              </button>
              <button
                onclick="showNotImplemented('导航')"
                class="w-full py-3 rounded-xl bg-shanghai-dark text-white font-bold hover:bg-shanghai-red transition-colors shadow-lg shadow-shanghai-dark/20 flex items-center justify-center"
              >
                <i class="fas fa-location-arrow mr-2"></i> 导航前往
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- JavaScript 逻辑 -->
    <script>
      // 1. 数据源
      const rawData = [
        {
          region: "人民广场及周边",
          name: "上海历史博物馆",
          desc: "综合反映上海地方历史及革命历史的博物馆，馆藏丰富。",
          metro: "人民广场站（1、2、8号线）",
          photos: [],
        },
        {
          region: "人民广场及周边",
          name: "上海外滩",
          desc: "上海的标志性景观带，汇集了52幢风格迥异的古典复兴大楼，素有'万国建筑博览群'之称，隔江对望陆家嘴现代金融区，是欣赏黄浦江两岸风光的最佳地点。",
          metro: "南京东路站（2、10号线）",
          photos: [
            "https://images.unsplash.com/photo-1501612780327-45045538702b?w=800&q=80",
            "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=800&q=80",
            "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&q=80"
          ],
        },
        {
          region: "远郊特色场馆",
          name: "上海海昌海洋公园",
          desc: "集海洋文化、科普教育、互动娱乐、休闲度假为一体的主题公园，拥有全球最大的极地海洋馆，展示珍稀海洋生物，提供精彩的海洋动物表演。",
          metro: "临港大道站（16号线）",
          photos: [
            "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&q=80",
            "https://images.unsplash.com/photo-1552728089-57bdde30beb3?w=800&q=80",
            "https://images.unsplash.com/photo-1580927752452-89d86da3fa0a?w=800&q=80"
          ],
        },
        {
          region: "远郊特色场馆",
          name: "耀雪冰雪世界",
          desc: "大型室内滑雪场，拥有专业级滑雪道和戏雪区域，适合不同水平的滑雪爱好者，同时提供冰雪主题娱乐项目，是四季皆宜的冰雪体验胜地。",
          metro: "临港大道站（16号线）",
          photos: [
            "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=800&q=80",
            "https://images.unsplash.com/photo-1485579149621-3123dd979885?w=800&q=80",
            "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=800&q=80"
          ],
        },
        {
          region: "人民广场及周边",
          name: "上海博物馆人民广场馆",
          desc: "综合性古代艺术博物馆，以青铜器、陶瓷器等见长。",
          metro: "人民广场站（1、2、8号线）",
          photos: [],
        },
        {
          region: "人民广场及周边",
          name: "南京路步行街",
          desc: "著名商业街，购物与老字号集中地。",
          metro: "南京东路站（2、10号线）",
          photos: [],
        },
        {
          region: "新天地-复兴路片区",
          name: "中共一大会址纪念馆（新天地商圈）",
          desc: "中国共产党诞生地，毗邻时尚新天地商圈。",
          metro: "一大会址·黄陂南路站（13号线）、新天地站（10、13号线）",
          photos: [],
        },
        {
          region: "新天地-复兴路片区",
          name: "孙中山故居（近思南公馆、复兴公园）",
          desc: "孙中山与宋庆龄故居，周边有思南公馆历史街区。",
          metro: "一大会址·黄陂南路站（13号线）、陕西南路站（1、10、12号线）",
          photos: [],
        },
        {
          region: "虹口北外滩商圈",
          name: "瑞虹天地太阳宫",
          desc: "大型商业综合体，位于瑞虹新城，拥有特色餐饮、亲子娱乐和创意零售。",
          metro: "临平路站（4号线）",
          photos: [],
        },
        {
          region: "静安苏河湾商圈",
          name: "上海静安大悦城",
          desc: "大型购物中心，以屋顶摩天轮和潮流艺术装置为特色，毗邻苏河湾。",
          metro: "曲阜路站（8、12号线）",
          photos: [],
        },
        {
          region: "静安寺-南京西路商圈",
          name: "南京西路静安寺商圈（含上海自然博物馆）",
          desc: "高端商圈与历史寺庙结合，上海自然博物馆也位于此。",
          metro: "静安寺站（2、7、14号线）",
          photos: [],
        },
        {
          region: "徐汇衡复风貌区",
          name: "宋庆龄故居（近武康大楼、上海交大）",
          desc: "宋庆龄生前居所，周边有武康大楼、交通大学徐汇校区。",
          metro: "交通大学站（10、11号线）",
          photos: [],
        },
        {
          region: "徐汇衡复风貌区",
          name: "钟书阁（绿地缤纷城店）",
          desc: "特色连锁书店，设计风格鲜明。",
          metro: "龙华中路站（7、12号线）",
          photos: [],
        },
        {
          region: "陆家嘴-世纪大道沿线",
          name: "陆家嘴-世纪大道商圈",
          desc: "金融中心，东方明珠、上海中心等地标所在地。",
          metro: "陆家嘴站（2号线）、世纪大道站（2、4、6、9号线）",
          photos: [],
        },
        {
          region: "陆家嘴-世纪大道沿线",
          name: "上海科技馆",
          desc: "大型科普教育场馆。",
          metro: "上海科技馆站（2号线）",
          photos: [],
        },
        {
          region: "陆家嘴-世纪大道沿线",
          name: "上海博物馆东馆",
          desc: "上博新馆，侧重古代艺术通史陈列。",
          metro: "上海科技馆站（2号线）",
          photos: [],
        },
        {
          region: "陆家嘴-世纪大道沿线",
          name: "上海图书馆东馆",
          desc: "现代智慧图书馆。",
          metro: "上海科技馆站（2号线）",
          photos: [],
        },
        {
          region: "浦东新兴商圈",
          name: "前滩太古里（含茑屋书店）",
          desc: "新兴商业地标，内含茑屋书店。",
          metro: "东方体育中心站（6、8、11号线）",
          photos: [],
        },
        {
          region: "浦东新兴商圈",
          name: "世博源",
          desc: "2010年世博会改造的商业综合体。",
          metro: "中华艺术宫站（8号线）",
          photos: [],
        },
        {
          region: "长宁-普陀商圈",
          name: "环球港",
          desc: "大型购物中心，集商业与文化一体。",
          metro: "金沙江路站（3、4、13号线）",
          photos: [],
        },
        {
          region: "长宁-普陀商圈",
          name: "龙之梦城市生活中心（长宁店）",
          desc: "综合购物中心，位于中山公园商圈。",
          metro: "中山公园站（2、3、4号线）",
          photos: [],
        },
        {
          region: "虹桥临空区域",
          name: "上海荟聚（宜家荟聚中心）",
          desc: "大型商业综合体，包含宜家家居等。",
          metro: "淞虹路站（2号线）",
          photos: [],
        },
        {
          region: "远郊特色场馆",
          name: "上海天文馆",
          desc: "全球最大天文馆之一，位于临港新区。",
          metro: "滴水湖站（16号线）",
          photos: [
            "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&q=80",
            "https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=800&q=80",
            "https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800&q=80"
          ],
        },
        {
          region: "远郊特色场馆",
          name: "上海迪士尼度假区",
          desc: "主题乐园与度假区。",
          metro: "迪士尼站（11号线）",
          photos: [
            "https://images.unsplash.com/photo-1513364776144-60967b0f800f?w=800&q=80",
            "https://images.unsplash.com/photo-1540979388789-6cee28a1cdc9?w=800&q=80",
            "https://images.unsplash.com/photo-1523580494863-6f3031224c94?w=800&q=80"
          ],
        },
        {
          region: "远郊特色场馆",
          name: "上海乐高乐园度假区",
          desc: "全球知名的乐高主题乐园，包含乐高积木搭建的创意建筑、互动游乐设施和精彩表演，适合全家亲子游玩。",
          metro: "淀山湖大道站（17号线）",
          photos: [
            "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&q=80",
            "https://images.unsplash.com/photo-1552728089-57bdde30beb3?w=800&q=80",
            "https://images.unsplash.com/photo-1580927752452-89d86da3fa0a?w=800&q=80"
          ],
        },
        {
          region: "其他文化场馆",
          name: "中国乒乓球博物馆",
          desc: "乒乓球主题博物馆，位于黄浦滨江。",
          metro: "鲁班路站（4号线）、西藏南路站（4、8号线）",
          photos: [],
        },
      ];

      let currentFilter = "全部";
      let searchQuery = "";
      let currentPage = "home";
      let favorites = new Set(); // 存储收藏的地点名称
      let pageSwitching = false; // 防止页面切换冲突

      // 每个页面的滚动位置追踪
      const pageScrollPositions = {
        home: 0,
        favorites: 0,
        itinerary: 0,
      };

      // LocalStorage 键名
      const FAVORITES_STORAGE_KEY = "shanghai_guide_favorites";

      // 2. 辅助函数

      // 从 LocalStorage 加载收藏数据
      function loadFavoritesFromStorage() {
        try {
          const stored = localStorage.getItem(FAVORITES_STORAGE_KEY);
          if (stored) {
            const favoritesArray = JSON.parse(stored);
            favorites = new Set(favoritesArray);
          }
        } catch (error) {
          console.error("加载收藏数据失败:", error);
          favorites = new Set();
        }
      }

      // 保存收藏数据到 LocalStorage
      function saveFavoritesToStorage() {
        try {
          const favoritesArray = Array.from(favorites);
          localStorage.setItem(
            FAVORITES_STORAGE_KEY,
            JSON.stringify(favoritesArray),
          );
        } catch (error) {
          console.error("保存收藏数据失败:", error);
        }
      }
      function getLineColor(lineNumber) {
        return (
          tailwind.config.theme.extend.colors.metro[`l${lineNumber}`] ||
          "#64748b"
        );
      }

      function generateMetroTags(metroString) {
        const lines = metroString.match(/\d+/g) || [];
        const stationName = metroString.split("（")[0];
        let tagsHtml = `<div class="flex items-center flex-wrap gap-1.5 mt-3 pt-3 border-t border-gray-100">`;
        tagsHtml += `<span class="text-[10px] font-bold text-gray-500 truncate"><i class="fas fa-subway mr-1"></i>${stationName}</span>`;
        lines.forEach((line) => {
          const color = getLineColor(line);
          tagsHtml += `<span class="px-1.5 py-0.5 rounded text-[10px] font-bold text-white shadow-sm" style="background-color: ${color}">${line}</span>`;
        });
        tagsHtml += `</div>`;
        return tagsHtml;
      }

      // 3. 音乐控制逻辑
      const audio = document.getElementById("bg-music");
      const musicBtn = document.getElementById("music-btn");
      const iconPlaying = document.getElementById("music-icon-playing");
      const iconPaused = document.getElementById("music-icon-paused");
      let isPlaying = false;

      function toggleMusic() {
        if (isPlaying) {
          audio.pause();
          iconPlaying.classList.add("hidden");
          iconPaused.classList.remove("hidden");
          musicBtn.classList.remove("music-playing");
        } else {
          audio
            .play()
            .then(() => {
              iconPlaying.classList.remove("hidden");
              iconPaused.classList.add("hidden");
              musicBtn.classList.add("music-playing");
            })
            .catch((error) => {
              console.log("Autoplay prevented:", error);
              alert("请点击页面任意位置以播放音乐");
            });
        }
        isPlaying = !isPlaying;
      }

      // 4. 初始化化
      function init() {
        loadFavoritesFromStorage(); // 加载收藏数据
        renderFilters();
        renderMasonry();

        // 搜索监听
        document
          .getElementById("search-input")
          .addEventListener("input", (e) => {
            searchQuery = e.target.value.toLowerCase();
            const clearBtn = document.getElementById("clear-btn");
            clearBtn.classList.toggle("hidden", searchQuery === "");
            renderMasonry();
          });

        // 尝试自动播放 (可能会被浏览器拦截)
        // document.body.addEventListener('click', () => {
        //     if(!isPlaying) toggleMusic();
        // }, { once: true });
      }

      // 5. 渲染筛选器
      function renderFilters() {
        const container = document.getElementById("region-filter");
        const regions = [
          "全部",
          ...new Set(rawData.map((item) => item.region)),
        ];

        container.innerHTML = regions
          .map(
            (region, index) => `
                <button
                    onclick="handleFilterClick(this, '${region}')"
                    class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300 whitespace-nowrap ${index === 0 && currentFilter === "全部" ? "bg-shanghai-dark text-white shadow-md" : "bg-white text-gray-500 border border-gray-200 hover:border-shanghai-red hover:text-shanghai-red"}"
                    data-region="${region}"
                >
                    ${region}
                </button>
            `,
          )
          .join("");
      }

      // 6. 处理筛选点击
      function handleFilterClick(btn, region) {
        currentFilter = region;
        // 更新按钮样式
        document.querySelectorAll("#region-filter button").forEach((b) => {
          b.className =
            "flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300 whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-shanghai-red hover:text-shanghai-red";
        });
        btn.className =
          "flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-300 whitespace-nowrap bg-shanghai-dark text-white shadow-md transform scale-105";
        renderMasonry();
      }

      function clearSearch() {
        document.getElementById("search-input").value = "";
        searchQuery = "";
        document.getElementById("clear-btn").classList.add("hidden");
        renderMasonry();
      }

      // 7. 渲染瀑布流 (无图片版)
      function renderMasonry() {
        const container = document.getElementById("masonry-grid");
        const emptyState = document.getElementById("empty-state");

        const filteredData = rawData.filter((item) => {
          const matchRegion =
            currentFilter === "全部" || item.region === currentFilter;
          const matchSearch =
            item.name.toLowerCase().includes(searchQuery) ||
            item.desc.toLowerCase().includes(searchQuery) ||
            item.metro.includes(searchQuery);
          return matchRegion && matchSearch;
        });

        if (filteredData.length === 0) {
          container.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        } else {
          emptyState.classList.add("hidden");
        }

        container.innerHTML = filteredData
          .map((item, index) => {
            // 提取第一条线路作为装饰色
            const firstLine = item.metro.match(/\d+/);
            const accentColor = firstLine
              ? getLineColor(firstLine[0])
              : "#E5E7EB";

            // 检查是否已收藏
            const isFavorited = favorites.has(item.name);

            return `
                <div class="break-inside-avoid mb-4 bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group border border-gray-100 flex flex-col cursor-pointer relative" onclick="openModal('${encodeURIComponent(item.name)}')">
                    <!-- 顶部装饰条 -->
                    <div class="h-2 w-full" style="background-color: ${accentColor}"></div>

                    <div class="p-5 flex flex-col flex-1 relative">
                        <!-- 收藏按钮 -->
                        <button class="absolute top-4 right-4 ${isFavorited ? "text-shanghai-red" : "text-gray-300"} hover:text-shanghai-red transition-colors z-10" onclick="event.stopPropagation(); toggleHeart(this)">
                            <i class="${isFavorited ? "fas" : "far"} fa-heart text-lg"></i>
                        </button>

                        <span class="text-[10px] font-bold text-shanghai-red tracking-wider uppercase mb-2 block">${item.region}</span>
                        <h3 class="font-bold text-slate-900 text-xl leading-snug mb-3 pr-6">${item.name}</h3>
                        <p class="text-sm text-gray-500 leading-relaxed line-clamp-4 flex-1 mb-4">${item.desc}</p>

                        <!-- 底部交通信息 -->
                        ${generateMetroTags(item.metro)}
                    </div>
                </div>
                `;
          })
          .join("");
      }

      // 8. 详情弹窗逻辑
      let modalOpening = false; // 防止重复打开
      let modalOpen = false; // 追踪模态框状态

      function openModal(encodedName) {
        // 防止快速重复点击
        if (modalOpening || modalOpen) return;
        modalOpening = true;
        modalOpen = true;

        const name = decodeURIComponent(encodedName);
        const item = rawData.find((d) => d.name === name);

        if (!item) {
          modalOpening = false;
          modalOpen = false;
          return;
        }

        // 填充数据
        document.getElementById("modal-title").innerText = item.name;
        document.getElementById("modal-region").innerText = item.region;
        document.getElementById("modal-desc").innerText = item.desc;
        document.getElementById("modal-metro-text").innerText =
          item.metro.split("（")[0];

        // 生成照片轮播图
        const photosContainer = document.getElementById("photos-container");
        if (item.photos && item.photos.length > 0) {
          photosContainer.innerHTML = item.photos
            .map(
              (photo) => `
              <div class="swiper-slide">
                <div class="relative overflow-hidden rounded-xl aspect-video bg-gray-100 group cursor-pointer" onclick="window.open('${photo}', '_blank')">
                  <img
                    src="${photo}"
                    alt="景点照片"
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                  <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fas fa-expand text-xs text-gray-600"></i>
                  </div>
                </div>
              </div>
            `
            )
            .join("");
          document.getElementById("modal-photos").classList.remove("hidden");

          // 初始化 Swiper
          initializeSwiper();
        } else {
          photosContainer.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-image-slash text-3xl mb-2"></i>
              <p class="text-sm">暂无照片</p>
            </div>
          `;
        }

        // 生成大标签
        const lines = item.metro.match(/\d+/g) || [];
        const tagsContainer = document.getElementById("modal-metro-tags");
        tagsContainer.innerHTML = lines
          .map((line) => {
            const color = getLineColor(line);
            return `<span class="px-3 py-1 rounded-lg text-sm font-bold text-white shadow-sm" style="background-color: ${color}">${line}号线</span>`;
          })
          .join("");

        // 显示
        const modal = document.getElementById("detail-modal");
        const backdrop = document.getElementById("modal-backdrop");
        const content = document.getElementById("modal-content");

        // 重置所有动画类
        content.classList.remove("modal-enter", "modal-exit");
        void content.offsetWidth; // 触发回流

        modal.classList.remove("hidden");
        backdrop.classList.remove("opacity-0");
        content.classList.add("modal-enter");

        document.body.style.overflow = "hidden";

        // 延迟重置标志
        setTimeout(() => {
          modalOpening = false;
        }, 300);
      }

      function closeModal() {
        const modal = document.getElementById("detail-modal");
        const backdrop = document.getElementById("modal-backdrop");
        const content = document.getElementById("modal-content");

        // 如果已经隐藏，直接返回
        if (modal.classList.contains("hidden") || !modalOpen) return;

        modalOpen = false;

        backdrop.classList.add("opacity-0");
        content.classList.remove("modal-enter");
        content.classList.add("modal-exit");

        setTimeout(() => {
          modal.classList.add("hidden");
          content.classList.remove("modal-exit");
          document.body.style.overflow = "";
          modalOpening = false;
        }, 300);
      }

      function toggleHeart(btn) {
        const card = btn.closest("div[onclick]");
        const onclickStr = card.getAttribute("onclick");
        const nameMatch = onclickStr.match(/openModal\('([^']+)'\)/);

        if (!nameMatch) return;

        const locationName = decodeURIComponent(nameMatch[1]);
        const icon = btn.querySelector("i");

        if (icon.classList.contains("far")) {
          // 添加收藏
          favorites.add(locationName);
          icon.classList.remove("far", "text-gray-300");
          icon.classList.add("fas", "text-shanghai-red");
          icon.classList.add("scale-125");
          setTimeout(() => icon.classList.remove("scale-125"), 200);
        } else {
          // 取消收藏
          favorites.delete(locationName);
          icon.classList.remove("fas", "text-shanghai-red");
          icon.classList.add("far", "text-gray-300");
        }

        // 保存到 LocalStorage
        saveFavoritesToStorage();

        // 更新收藏页
        renderFavorites();

        // 始终更新首页的收藏图标状态（确保同步）
        renderMasonry();
      }

      // 渲染收藏页面
      function renderFavorites() {
        const container = document.getElementById("favorites-grid");
        const emptyState = document.getElementById("favorites-empty");
        const countEl = document.getElementById("favorites-count");

        const favoriteLocations = rawData.filter((item) => {
          return favorites.has(item.name);
        });

        countEl.textContent = `${favoriteLocations.length} 个地点`;

        if (favoriteLocations.length === 0) {
          container.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        } else {
          emptyState.classList.add("hidden");
        }

        container.innerHTML = favoriteLocations
          .map((item, index) => {
            const firstLine = item.metro.match(/\d+/);
            const accentColor = firstLine
              ? getLineColor(firstLine[0])
              : "#E5E7EB";

            return `
                <div class="break-inside-avoid mb-4 bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group border border-gray-100 flex flex-col cursor-pointer relative" onclick="openModal('${encodeURIComponent(item.name)}')">
                    <!-- 顶部装饰条 -->
                    <div class="h-2 w-full" style="background-color: ${accentColor}"></div>

                    <div class="p-5 flex flex-col flex-1 relative">
                        <!-- 收藏按钮 -->
                        <button class="absolute top-4 right-4 text-shanghai-red transition-colors z-10" onclick="event.stopPropagation(); toggleHeart(this)">
                            <i class="fas fa-heart text-lg"></i>
                        </button>

                        <span class="text-[10px] font-bold text-shanghai-red tracking-wider uppercase mb-2 block">${item.region}</span>
                        <h3 class="font-bold text-slate-900 text-xl leading-snug mb-3 pr-6">${item.name}</h3>
                        <p class="text-sm text-gray-500 leading-relaxed line-clamp-4 flex-1 mb-4">${item.desc}</p>

                        <!-- 底部交通信息 -->
                        ${generateMetroTags(item.metro)}
                    </div>
                </div>
                `;
          })
          .join("");
      }

      // 页面切换
      function switchPage(pageName) {
        if (pageSwitching || currentPage === pageName) return;
        pageSwitching = true;

        const tabs = document.querySelectorAll(".tab-item");
        const pages = document.querySelectorAll(".page-section");
        const currentPageEl = document.getElementById(`page-${currentPage}`);
        const newPageEl = document.getElementById(`page-${pageName}`);
        const header = document.getElementById("main-header");

        // 保存当前页面的滚动位置
        pageScrollPositions[currentPage] =
          window.pageYOffset || document.documentElement.scrollTop;

        // 更新 Tab 样式
        tabs.forEach((tab) => {
          if (tab.getAttribute("data-page") === pageName) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });

        // 页面退出动画
        currentPageEl.classList.add("page-exit");

        setTimeout(() => {
          currentPageEl.classList.add("hidden");
          currentPageEl.classList.remove("page-exit");

          // 显示新页面
          newPageEl.classList.remove("hidden");
          newPageEl.classList.add("page-enter");

          // 控制头部显示：只在首页显示
          if (pageName === "home") {
            header.classList.remove("hidden");
          } else {
            header.classList.add("hidden");
          }

          // 如果切换到收藏页，重新渲染
          if (pageName === "favorites") {
            renderFavorites();
          }

          setTimeout(() => {
            newPageEl.classList.remove("page-enter");
            currentPage = pageName;
            pageSwitching = false;

            // 恢复新页面的滚动位置
            const savedScrollPosition = pageScrollPositions[pageName] || 0;
            window.scrollTo(0, savedScrollPosition);
          }, 300);
        }, 300);
      }

      function showNotImplemented(feature) {
        alert(`${feature}功能暂未实现`);
      }

      // 初始化 Swiper 轮播图
      function initializeSwiper() {
        // 先销毁已存在的实例
        if (window.photosSwiper) {
          window.photosSwiper.destroy();
        }

        // 获取当前轮播图的照片数量
        const slides = document.querySelectorAll(".swiper-slide");
        const hasMultipleSlides = slides.length > 1;

        // 初始化新实例
        window.photosSwiper = new Swiper(".photos-swiper", {
          slidesPerView: 1,
          spaceBetween: 0,
          loop: hasMultipleSlides,
          autoplay: {
            delay: 3000,
            disableOnInteraction: false,
          },
          pagination: {
            el: ".swiper-pagination",
            clickable: true,
          },
          navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
          },
          effect: "slide",
          speed: 300,
        });
      }

      // 启动
      init();
      renderFavorites(); // 初始化收藏页
    </script>
  </body>
</html>
